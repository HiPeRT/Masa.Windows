<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>MODENA AUTOMOTIVE SMART AREA</title>

    <link rel="stylesheet" href="./Resources/main.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <script src="./Resources/library.js"></script>
    <script>

        function enable(name, onoff) {
            if (!onoff) {
                $(name).attr('disabled', 'disabled');
            } else {
                $(name).removeAttr('disabled');
            }
        }
        function selMaster_OnChange() {
            var selMaster = $('#selMaster').val();

            enable("#selState", selMaster == 1);
        }

        function log(msg) {

            $('#logLabel').text(msg);
        }

		function GetImageByTlState(tl_state) {
			switch (tl_state) {
				case 0:
					return "off.gif";
				case 1:
					return "green.gif";
				case 2:
					return "yellow-green.gif";
				case 3:
					return "red.gif";
				case 4:
					return "red-yellow.gif";
			}
		}

        function GetImage(status) {

            //log(status.ctrl_type + " " + status.tl_state);
            switch (status.ctrl_type) {
                case 0: // Unknown
                    return "off.gif";

                case 1: // Server
					return GetImageByTlState(status.tl_state);

                case 2: // Modbus
					switch(status.tl_mode)
					{
						case 0:
							return GetImageByTlState(status.tl_state);
						case 1:
							// Only tla1
							switch (status.phase) {
								case 0:
									return "off.gif";

								case 1:
									return "green.gif";

								case 2:
								case 6:
									return "yellow-green.gif";

								case 3:
								case 4:
									return "red.gif";

								case 5:
                                    return "yellow-blinking.gif";

								case 7:
									return "red-yellow.gif";
							}
						case 2:
								return "yellow-blinking.gif";
					}
                    break;

                case 3: // Internal
                    return GetImageByTlState(status.tl_state);
                    break;
            } // switch
        } // fn

		function GetSelectValue(name, key) {
			return $(name + ' option[value="' + key + '"]').html();
		}

		function UpdateSemStatus(res) {
			//log("id: " + res.id +
			//    " - master: " + res.ctrl_type +
			//    " - tl_state: " + res.tl_state +
			//    " - phase: " + res.phase +
			//    " - tl_mode: " + res.tl_mode +
			//    " - status: " + res.status +
			//    " - image: " + img);

		}

        var img = "";
        function OnLoad() {
            setInterval(function () {
                var name = $("#semNameLabel").text();

                //alert('Get info for semaphore ' + name);
                HttpCall(urlBase + "/api/semaphore/" + name + "/status", 'GET', "", function (res) {

                   
                    $('#lblCtrl').html(GetSelectValue('#selCtrl', res.ctrl_type));
                });
            }, 300);

            $('#btnSubmit').on('click', function (event) {

                var name = $("#semNameLabel").text();
                var key = $('#textKey').val();
                var ctrl = $('#selCtrl').find("option:selected").val();

				var obj = new Object();
				obj.key = key;
				obj.status = new Object();
				obj.status.id = name;
				obj.status.ctrl_type = master;

                HttpCall(urlBase + "/api/semaphore/" + name + "/ctrl", 'POST', obj, function (res) {
                    log("OK");
                });

                //alert(key+master+phase+mode+state);

            });
            selMaster_OnChange();
        }
    </script>
</head>

<body class="homepage" onload="OnLoad()">
    <div id="page-wrapper">
        <img src="./Resources/logo-masa.png" class="logocomune" alt="loghi">
        <!-- Header -->
        <header id="header">
            <div class="logo container">
                <div>
                    <p>MODENA AUTOMOTIVE SMART AREA -- </p>
                    <h1>VEHICLE '<label id="semNameLabel">car1</label>'</h1>
                </div>
            </div>
        </header>
        <!-- Banner -->
        
        <div id="banner-wrapper">
            <section id="banner" style="width:15%; float:left; text-align:left; padding-left:20px">


                <button type="button" id="btnSubmit" class="btn btn-danger myselect">Save</button>
                <br /><br />

                <div class="form-group btn btn-secondary myselect">
                    <label for="textKey">Key</label><br />
                    <input type="password" id="textKey" style="width:220px" />
                </div>
                <br />

                <div class="form-group btn btn-primary myselect">
                    Master: <label id="lblCtrl" for="selCtrl"></label>
                    <select class="form-control" id="selCtrl" onchange="selCtrl_OnChange()">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                </div>
                <br />

                <div class="form-group btn btn-info myselect">
                    State: <label id="lblState" for="selState"></label>
                    <select class="form-control" id="selState" disabled>
                        <option value="0">Off</option>
                        <option value="1">Green</option>
                        <option value="2">Green + yellow</option>
                        <option value="3">Red</option>
                        <option value="4">Red + yellow</option>
                    </select>
                </div>
                <br />

                <div class="form-group btn btn-success myselect">
                    Phase: <label id="lblPhase" for="selPhase"></label>
                    <!--<select class="form-control" id="selPhase" disabled>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                    </select>-->
                </div>
                <br />

                <div class="form-group btn btn-warning myselect">
                    Mode: <label id="lblMode" for="selMode"></label>
                    <!--<select class="form-control" id="selMode" disabled>
                        <option value="0">Manual</option>
                        <option value="1">Driven by Phase</option>
                        <option value="2">Blinking yellow</option>
                    </select>-->
                </div>
            </section>
            <div style="text-align:center">
                <img src="./Resources/Lights/off.gif" id="imgLights" />
            </div>
        </div>
    </div>
</body>
</html>